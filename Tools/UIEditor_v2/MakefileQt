ifeq ($(OS),Windows_NT)
	os_mkdir=-(pushd $1 && popd) || mkdir $(subst /,\,$1)
	os_rm=del /F /Q $(subst /,\,$1)
	os_generate_header=@for %%i in ($1) do ( echo \#include "%%i">> $2 )
	OS_UIC:="$(QT_HOME)\bin\uic.exe"
	OS_MOC:="$(QT_HOME)\bin\moc.exe"
	OS_RCC:="$(QT_HOME)\bin\rcc.exe"
	OS_INFO:=Windows
else
	os_mkdir=mkdir -p $1
	os_rm=-rm -f $1
	os_generate_header=for fileName in $1; do echo "\#include \"$$fileName\"">> $2; done
	OS_UIC:=/Developer/Tools/Qt/uic
	OS_MOC:=/Developer/Tools/Qt/moc
	OS_RCC:=/Developer/Tools/Qt/rcc
	OS_INFO:=Unix
endif

QT_DIR_OUTPUT := GeneratedFiles
QT_DIR_UI_OUTPUT := $(QT_DIR_OUTPUT)/Ui
QT_DIR_UI := UI
QT_DIR_QRC_OUTPUT := $(QT_DIR_OUTPUT)/Qrc
QT_DIR_QRC := Data
QT_DIR_QRC_HEADER := $(QT_DIR_OUTPUT)/QrcSourcesHeader.h
QT_DIR_MOC_OUTPUT := $(QT_DIR_OUTPUT)/Moc
QT_DIR_MOC := Classes
QT_DIR_MOC_HEADER := $(QT_DIR_OUTPUT)/MocSourcesHeader.h

QT_UI_FILES := $(wildcard $(QT_DIR_UI)/*.ui)
QT_UI_FILES_GEN := $(addprefix $(QT_DIR_UI_OUTPUT)/ui_, $(notdir $(QT_UI_FILES:.ui=.h)))

QT_MOC_FILES := $(wildcard $(QT_DIR_MOC)/*.h) $(wildcard $(QT_DIR_MOC)/**/*.h)  $(wildcard $(QT_DIR_MOC)/**/**/*.h) $(wildcard $(QT_DIR_MOC)/**/**/**/*.h)
QT_MOC_FILES_GEN := $(subst $(QT_DIR_MOC), $(QT_DIR_MOC_OUTPUT), $(QT_MOC_FILES:.h=_moc.cpp))

QT_MOC_FILES_ADDI := $(subst .needmeta, , $(wildcard $(QT_DIR_MOC)/*.needmeta) $(wildcard $(QT_DIR_MOC)/**/*.needmeta) $(wildcard $(QT_DIR_MOC)/**/**/*.needmeta) $(wildcard $(QT_DIR_MOC)/**/**/**/*.needmeta))
QT_MOC_FILES_GEN_ADDI := $(subst $(QT_DIR_MOC), $(QT_DIR_MOC_OUTPUT), $(QT_MOC_FILES_ADDI:.cpp=_moca.cpp))

QT_QRC_FILES := $(wildcard $(QT_DIR_QRC)/*.qrc) $(wildcard $(QT_DIR_QRC)/**/*.qrc) $(wildcard $(QT_DIR_QRC)/**/**/*.qrc) $(wildcard $(QT_DIR_QRC)/**/**/**/*.qrc)
QT_QRC_FILES_GEN := $(subst $(QT_DIR_QRC), $(QT_DIR_QRC_OUTPUT), $(QT_QRC_FILES:.qrc=_qrc.cpp))

.PHONY: os_info

all: os_info $(QT_DIR_UI_OUTPUT) $(QT_UI_FILES_GEN) $(QT_DIR_QRC_OUTPUT) $(QT_QRC_FILES_GEN) $(QT_DIR_MOC_OUTPUT) $(QT_MOC_FILES_GEN) $(QT_MOC_FILES_GEN_ADDI) $(QT_DIR_MOC_HEADER) $(QT_DIR_QRC_HEADER)
	@echo Done.

$(QT_DIR_UI_OUTPUT):
	@$(call os_mkdir, $@)

$(QT_DIR_QRC_OUTPUT):
	@$(call os_mkdir, $@)

$(QT_DIR_MOC_OUTPUT):
	@$(call os_mkdir, $@)

$(QT_DIR_UI_OUTPUT)/ui_%.h : $(QT_DIR_UI)/%.ui
	@echo $@
	$(OS_UIC) $< -o $@

$(QT_DIR_MOC_OUTPUT)/%_moc.cpp : $(QT_DIR_MOC)/%.h
	@echo $@
	@$(call os_rm, $(QT_DIR_MOC_HEADER))
	@$(call os_mkdir, "$(dir $@)")
	@$(OS_MOC) -nn $< -o "$@"

$(QT_DIR_MOC_OUTPUT)/%_moca.cpp : $(QT_DIR_MOC)/%.cpp
	@echo $@
	@$(call os_rm, $(QT_DIR_MOC_HEADER))
	@$(call os_mkdir, "$(dir $@)")
	@$(OS_MOC) -nn $< -o "$@"

$(QT_DIR_QRC_OUTPUT)/%_qrc.cpp : $(QT_DIR_QRC)/%.qrc
	@echo $@
	@$(call os_rm, $(QT_DIR_QRC_HEADER))
	@$(OS_RCC) -name $(notdir $(basename $<)) $< -o $@

$(QT_DIR_MOC_HEADER): $(QT_MOC_FILES_GEN)
	@echo Generating Moc header
	$(call os_generate_header,$(QT_MOC_FILES_GEN),$(QT_DIR_MOC_HEADER))
	$(call os_generate_header,$(QT_MOC_FILES_GEN_ADDI),$(QT_DIR_MOC_HEADER))

$(QT_DIR_QRC_HEADER): $(QT_QRC_FILES_GEN)
	@echo Generating Qrc header
	$(call os_generate_header,$(QT_QRC_FILES_GEN),$(QT_DIR_QRC_HEADER))

os_info:
	@echo Running for $(OS_INFO):
